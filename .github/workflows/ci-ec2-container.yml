# =============================================================================
# EC2 Self-Hosted Runner + Container ê¸°ë°˜ CI ì›Œí¬í”Œë¡œìš°
# =============================================================================
#
# ðŸŽ¯ ì´ ì›Œí¬í”Œë¡œìš°ê°€ ë³´ì—¬ì£¼ëŠ” í•µì‹¬ ê°œë…:
#
# 1ï¸âƒ£ Workspace Cleanup (ì›Œí¬ìŠ¤íŽ˜ì´ìŠ¤ ì •ë¦¬)
#    - Kubernetes: emptyDir ë³¼ë¥¨ìœ¼ë¡œ Pod ì¢…ë£Œ ì‹œ ìžë™ ì‚­ì œ
#    - EC2: Runnerê°€ ì§€ì†ë˜ë¯€ë¡œ ìˆ˜ë™ìœ¼ë¡œ cleanup í•„ìš”!
#
# 2ï¸âƒ£ Container ê¸°ë°˜ ì‹¤í–‰
#    - EC2 Runner ìœ„ì—ì„œ íŠ¹ì • Docker ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œ ë¹Œë“œ ì‹¤í–‰
#    - ë¹Œë“œ í™˜ê²½ì˜ ì¼ê´€ì„± ë³´ìž¥ (íŠ¹ì • ë²„ì „ì˜ ì»´íŒŒì¼ëŸ¬, ë¼ì´ë¸ŒëŸ¬ë¦¬ ë“±)
#
# =============================================================================

name: CI (EC2 + Container)

on:
  workflow_dispatch:
    inputs:
      container-image:
        description: 'Docker image for build (e.g., gcc:12, ubuntu:22.04)'
        required: false
        default: 'gcc:12'
      cleanup-before:
        description: 'Cleanup workspace before build'
        required: false
        default: 'true'
      cleanup-after:
        description: 'Cleanup workspace after build'
        required: false
        default: 'true'

jobs:
  # ===========================================================================
  # Job 1: EC2 Self-Hosted Runnerì—ì„œ Container ê¸°ë°˜ ë¹Œë“œ
  # ===========================================================================
  build-in-container:
    runs-on: [self-hosted, aws-ec2]
    
    # -------------------------------------------------------------------------
    # ðŸ³ Container ì„¤ì •
    # -------------------------------------------------------------------------
    # EC2 Runner ìœ„ì—ì„œ ì§€ì •ëœ Docker ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œ ëª¨ë“  steps ì‹¤í–‰
    # - Dockerê°€ EC2ì— ì„¤ì¹˜ë˜ì–´ ìžˆì–´ì•¼ í•¨
    # - ì»¨í…Œì´ë„ˆëŠ” ê° job ì‹œìž‘ ì‹œ ìƒì„±ë˜ê³  ì¢…ë£Œ ì‹œ ì‚­ì œë¨
    # - ë³¼ë¥¨ ë§ˆìš´íŠ¸: ì›Œí¬ìŠ¤íŽ˜ì´ìŠ¤($GITHUB_WORKSPACE)ê°€ ì»¨í…Œì´ë„ˆì— ë§ˆìš´íŠ¸ë¨
    # -------------------------------------------------------------------------
    container:
      image: ${{ github.event.inputs.container-image || 'gcc:12' }}
      # ì˜µì…˜: í™˜ê²½ë³€ìˆ˜, ë³¼ë¥¨, ë„¤íŠ¸ì›Œí¬ ë“± ì„¤ì • ê°€ëŠ¥
      # options: --user root
      # volumes:
      #   - /cache:/cache
      # env:
      #   CC: gcc-12
    
    steps:
      # -----------------------------------------------------------------------
      # ðŸ§¹ Step 1: Pre-Cleanup (ë¹Œë“œ ì „ ì›Œí¬ìŠ¤íŽ˜ì´ìŠ¤ ì •ë¦¬)
      # -----------------------------------------------------------------------
      # âš ï¸ ì™œ í•„ìš”í•œê°€?
      # - EC2 RunnerëŠ” Kubernetesì™€ ë‹¬ë¦¬ ì§€ì†ì ìœ¼ë¡œ ì‹¤í–‰ë¨
      # - ì´ì „ ë¹Œë“œì˜ íŒŒì¼ì´ ë‚¨ì•„ìžˆì„ ìˆ˜ ìžˆìŒ (ìºì‹œ ì¶©ëŒ, ë¹Œë“œ ì˜¤ë¥˜ ìœ ë°œ)
      # - íŠ¹ížˆ ë™ì¼ Runnerì—ì„œ ì—¬ëŸ¬ í”„ë¡œì íŠ¸ ë¹Œë“œ ì‹œ ì¤‘ìš”
      # -----------------------------------------------------------------------
      - name: ðŸ§¹ Pre-Cleanup Workspace
        if: ${{ github.event.inputs.cleanup-before != 'false' }}
        run: |
          echo "=========================================="
          echo "ðŸ§¹ Cleaning workspace BEFORE build..."
          echo "=========================================="
          echo "Current directory: $(pwd)"
          echo "GITHUB_WORKSPACE: $GITHUB_WORKSPACE"
          
          # ë°©ë²• 1: ì „ì²´ ì‚­ì œ (ê¶Œìž¥)
          rm -rf "$GITHUB_WORKSPACE"/* "$GITHUB_WORKSPACE"/.[!.]* 2>/dev/null || true
          
          # ë°©ë²• 2: íŠ¹ì • ë””ë ‰í† ë¦¬ë§Œ ì‚­ì œ
          # rm -rf build/ out/ node_modules/ .cache/ 2>/dev/null || true
          
          echo "âœ… Pre-cleanup completed"
          ls -la "$GITHUB_WORKSPACE" || echo "Workspace is empty"

      # -----------------------------------------------------------------------
      # ðŸ“¥ Step 2: Checkout
      # -----------------------------------------------------------------------
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          clean: true  # checkout ì „ì— git clean ì‹¤í–‰
          
      # -----------------------------------------------------------------------
      # ðŸ” Step 3: í™˜ê²½ ì •ë³´ í™•ì¸
      # -----------------------------------------------------------------------
      - name: ðŸ” Check build environment
        run: |
          echo "=========================================="
          echo "ðŸ” Build Environment Info"
          echo "=========================================="
          echo "Container Image: ${{ github.event.inputs.container-image || 'gcc:12' }}"
          echo ""
          echo "ðŸ“‹ System Info:"
          cat /etc/os-release 2>/dev/null | head -5 || echo "Unknown OS"
          echo ""
          echo "ðŸ”§ Compiler Info:"
          gcc --version 2>/dev/null || echo "GCC not found"
          g++ --version 2>/dev/null || echo "G++ not found"
          cmake --version 2>/dev/null || echo "CMake not found"
          echo ""
          echo "ðŸ“ Workspace Contents:"
          ls -la

      # -----------------------------------------------------------------------
      # ðŸ”¨ Step 4: ì˜ì¡´ì„± ì„¤ì¹˜ ë° ë¹Œë“œ
      # -----------------------------------------------------------------------
      - name: ðŸ“¦ Install dependencies
        run: |
          echo "Installing build dependencies..."
          apt-get update -qq
          apt-get install -y -qq cmake ninja-build
          
      - name: ðŸ”¨ Configure CMake
        working-directory: src
        run: |
          cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release
          
      - name: ðŸ—ï¸ Build
        working-directory: src
        run: |
          cmake --build build --config Release
          
      - name: ðŸ“‹ List build outputs
        working-directory: src
        run: |
          echo "Build outputs:"
          find build -type f -executable -o -name "*.a" -o -name "*.so" 2>/dev/null || true

      # -----------------------------------------------------------------------
      # ðŸ“¤ Step 5: Artifacts ì—…ë¡œë“œ
      # -----------------------------------------------------------------------
      - name: ðŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cpp-build-ec2-container
          path: src/build/
          retention-days: 7

      # -----------------------------------------------------------------------
      # ðŸ§¹ Step 6: Post-Cleanup (ë¹Œë“œ í›„ ì›Œí¬ìŠ¤íŽ˜ì´ìŠ¤ ì •ë¦¬)
      # -----------------------------------------------------------------------
      # âš ï¸ ì™œ í•„ìš”í•œê°€?
      # - ë‹¤ìŒ ë¹Œë“œë¥¼ ìœ„í•´ ê¹¨ë—í•œ ìƒíƒœ ìœ ì§€
      # - ë””ìŠ¤í¬ ê³µê°„ í™•ë³´ (íŠ¹ížˆ ë¹Œë“œ ê²°ê³¼ë¬¼ì´ í° ê²½ìš°)
      # - ë³´ì•ˆ: ë¯¼ê°í•œ ì •ë³´(credentials, secrets)ê°€ ë‚¨ì§€ ì•Šë„ë¡
      # -----------------------------------------------------------------------
      - name: ðŸ§¹ Post-Cleanup Workspace
        if: always() && github.event.inputs.cleanup-after != 'false'
        run: |
          echo "=========================================="
          echo "ðŸ§¹ Cleaning workspace AFTER build..."
          echo "=========================================="
          
          # ë¹Œë“œ ê²°ê³¼ë¬¼ ì‚­ì œ
          rm -rf "$GITHUB_WORKSPACE"/* "$GITHUB_WORKSPACE"/.[!.]* 2>/dev/null || true
          
          # Docker ê´€ë ¨ ì •ë¦¬ (í•„ìš”ì‹œ)
          # docker system prune -f 2>/dev/null || true
          
          echo "âœ… Post-cleanup completed"

  # ===========================================================================
  # Job 2: Container ì—†ì´ EC2 Runnerì—ì„œ ì§ì ‘ ì‹¤í–‰ (ë¹„êµìš©)
  # ===========================================================================
  build-on-host:
    runs-on: [self-hosted, aws-ec2]
    needs: build-in-container
    if: false  # ê¸°ë³¸ì ìœ¼ë¡œ ë¹„í™œì„±í™” (ë°ëª¨ìš©)
    
    steps:
      - name: ðŸ§¹ Pre-Cleanup
        run: rm -rf * .[!.]* 2>/dev/null || true
        
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ðŸ”¨ Build (Hostì—ì„œ ì§ì ‘)
        working-directory: src
        run: |
          # EC2 í˜¸ìŠ¤íŠ¸ì— ì„¤ì¹˜ëœ ë„êµ¬ ì‚¬ìš©
          cmake -B build -DCMAKE_BUILD_TYPE=Release
          cmake --build build
          
      - name: ðŸ§¹ Post-Cleanup
        if: always()
        run: rm -rf * .[!.]* 2>/dev/null || true

  # ===========================================================================
  # Job 3: ì—¬ëŸ¬ ì»¨í…Œì´ë„ˆì—ì„œ Matrix ë¹Œë“œ
  # ===========================================================================
  matrix-container-build:
    runs-on: [self-hosted, aws-ec2]
    needs: build-in-container
    if: false  # ê¸°ë³¸ì ìœ¼ë¡œ ë¹„í™œì„±í™” (ë°ëª¨ìš©)
    
    strategy:
      matrix:
        container: ['gcc:11', 'gcc:12', 'gcc:13']
        
    container:
      image: ${{ matrix.container }}
      
    steps:
      - name: ðŸ§¹ Pre-Cleanup
        run: rm -rf /github/workspace/* 2>/dev/null || true
        
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ðŸ”¨ Build in ${{ matrix.container }}
        run: |
          apt-get update -qq && apt-get install -y -qq cmake
          cd src && cmake -B build && cmake --build build
          
      - name: ðŸ§¹ Post-Cleanup
        if: always()
        run: rm -rf /github/workspace/* 2>/dev/null || true
