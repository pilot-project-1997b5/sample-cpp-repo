# =============================================================================
# Mac Self-Hosted Runner í…ŒìŠ¤íŠ¸ìš© CI ì›Œí¬í”Œë¡œìš°
# =============================================================================
# 
# ðŸŽ¯ ëª©ì : EC2 ë°°í¬ ì „ Macì—ì„œ Self-hosted Runner ë™ìž‘ í…ŒìŠ¤íŠ¸
# 
# âš ï¸ ì£¼ì˜: Macì—ì„œëŠ” Docker container ì‹¤í–‰ì´ Linuxì™€ ë‹¤ë¦„
#    - Docker Desktop í•„ìš”
#    - Linux containerëŠ” VM ìœ„ì—ì„œ ì‹¤í–‰ë¨
# =============================================================================

name: CI (Mac Self-Hosted Test)

on:
  workflow_dispatch:
    inputs:
      use-container:
        description: 'Run in Docker container (requires Docker Desktop)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  # ===========================================================================
  # Job 1: Mac Runnerì—ì„œ ì§ì ‘ ë¹Œë“œ (Container ì—†ì´)
  # ===========================================================================
  build-on-mac:
    if: ${{ github.event.inputs.use-container != 'true' }}
    runs-on: [self-hosted, macOS]
    
    steps:
      # ðŸ§¹ Pre-Cleanup
      - name: ðŸ§¹ Pre-Cleanup Workspace
        run: |
          echo "=========================================="
          echo "ðŸ§¹ Cleaning workspace BEFORE build..."
          echo "=========================================="
          rm -rf "$GITHUB_WORKSPACE"/* "$GITHUB_WORKSPACE"/.[!.]* 2>/dev/null || true
          echo "âœ… Pre-cleanup completed"

      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ” Check Mac build environment
        run: |
          echo "=========================================="
          echo "ðŸ” Mac Build Environment Info"
          echo "=========================================="
          echo "ðŸ–¥ï¸ macOS Version:"
          sw_vers
          echo ""
          echo "ðŸ”§ Available Compilers:"
          which gcc && gcc --version 2>/dev/null || echo "GCC not found"
          which clang && clang --version 2>/dev/null || echo "Clang not found"
          echo ""
          echo "ðŸ“¦ Build Tools:"
          which cmake && cmake --version 2>/dev/null || echo "CMake not found (install: brew install cmake)"
          which ninja && ninja --version 2>/dev/null || echo "Ninja not found (install: brew install ninja)"
          echo ""
          echo "ðŸ³ Docker:"
          which docker && docker --version 2>/dev/null || echo "Docker not installed"

      - name: ðŸ“¦ Install dependencies (if needed)
        run: |
          # Homebrewë¡œ í•„ìš”í•œ ë„êµ¬ ì„¤ì¹˜
          if ! command -v cmake &> /dev/null; then
            echo "Installing CMake..."
            brew install cmake
          fi
          if ! command -v ninja &> /dev/null; then
            echo "Installing Ninja..."
            brew install ninja
          fi

      - name: ðŸ”¨ Configure CMake
        working-directory: src
        run: |
          cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release
          
      - name: ðŸ—ï¸ Build
        working-directory: src
        run: |
          cmake --build build --config Release
          
      - name: ðŸ“‹ List build outputs
        working-directory: src
        run: |
          echo "Build outputs:"
          find build -type f -perm +111 -o -name "*.a" -o -name "*.dylib" 2>/dev/null || true

      - name: ðŸ“¤ Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cpp-build-mac
          path: src/build/
          retention-days: 7

      # ðŸ§¹ Post-Cleanup
      - name: ðŸ§¹ Post-Cleanup Workspace
        if: always()
        run: |
          echo "=========================================="
          echo "ðŸ§¹ Cleaning workspace AFTER build..."
          echo "=========================================="
          rm -rf "$GITHUB_WORKSPACE"/* "$GITHUB_WORKSPACE"/.[!.]* 2>/dev/null || true
          echo "âœ… Post-cleanup completed"

  # ===========================================================================
  # Job 2: Mac + Docker Container ë¹Œë“œ
  # ===========================================================================
  build-in-container-mac:
    if: ${{ github.event.inputs.use-container == 'true' }}
    runs-on: [self-hosted, macOS]
    
    # âš ï¸ Macì—ì„œ container ì‚¬ìš© ì‹œ ì£¼ì˜ì‚¬í•­:
    # - Docker Desktopì´ ì‹¤í–‰ ì¤‘ì´ì–´ì•¼ í•¨
    # - Linux containerëŠ” ë‚´ë¶€ VMì—ì„œ ì‹¤í–‰ë¨
    container:
      image: gcc:12
      
    steps:
      - name: ðŸ§¹ Pre-Cleanup
        run: rm -rf /github/workspace/* 2>/dev/null || true

      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ðŸ” Check container environment
        run: |
          echo "Container: gcc:12"
          cat /etc/os-release | head -3
          gcc --version

      - name: ðŸ“¦ Install CMake
        run: |
          apt-get update -qq
          apt-get install -y -qq cmake ninja-build

      - name: ðŸ”¨ Build
        working-directory: src
        run: |
          cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release
          cmake --build build

      - name: ðŸ“¤ Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cpp-build-container-mac
          path: src/build/
          retention-days: 7

      - name: ðŸ§¹ Post-Cleanup
        if: always()
        run: rm -rf /github/workspace/* 2>/dev/null || true
